<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>SKRC wav â†’ ogg å¤‰æ›ãƒ„ãƒ¼ãƒ«ï¼ˆé€£æ‰“å¯¾å¿œæœ€çµ‚ç‰ˆï¼‰</title>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<style>
body {
  background:#111;
  color:#eee;
  font-family:sans-serif;
  padding:20px;
}
button {
  padding:12px 20px;
  font-size:16px;
}
button:disabled {
  opacity:0.5;
}
#log {
  white-space:pre-line;
  margin-top:15px;
  font-size:14px;
}
#status {
  margin-top:10px;
  font-size:15px;
}
</style>
</head>

<body>
<h2>ğŸš„ SKRC wav â†’ ogg å¤‰æ›ãƒ„ãƒ¼ãƒ«</h2>

<p>â‘  wavå…¥ã‚Šzipã‚’é¸æŠ</p>
<input type="file" id="zip" accept=".zip"><br><br>

<p>â‘¡ å¤‰æ›ï¼ˆ1å›ï¼1ãƒ•ã‚¡ã‚¤ãƒ« / é•·æŠ¼ã—ï¼è‡ªå‹•ï¼‰</p>
<button id="convertBtn">â–¶ å¤‰æ›ã™ã‚‹</button>

<div id="status"></div>
<div id="log"></div>

<script>
/* ===== å…±é€š ===== */
function log(t){
  document.getElementById("log").textContent += t + "\n";
}
function setStatus(t){
  document.getElementById("status").textContent = t;
}

let wavList = [];
let index = 0;
let converting = false;
let autoTimer = null;

let audioCtx = null;
let dest = null;
let recorder = null;
let chunks = null;

const outZip = new JSZip();

/* ===== Audio åˆæœŸåŒ– ===== */
async function initAudio(){
  if(audioCtx) return;

  audioCtx = new AudioContext();
  await audioCtx.resume();

  dest = audioCtx.createMediaStreamDestination();
  recorder = new MediaRecorder(dest.stream, { mimeType:"audio/ogg" });
  recorder.ondataavailable = e => chunks.push(e.data);
}

/* ===== wav â†’ oggï¼ˆè¶…å®‰å®šï¼‰ ===== */
async function wavToOgg(blob){
  await initAudio();

  const buf = await blob.arrayBuffer();
  const buffer = await audioCtx.decodeAudioData(buf);

  const src = audioCtx.createBufferSource();
  src.buffer = buffer;
  src.connect(audioCtx.destination); // â˜… ç„¡éŸ³é˜²æ­¢
  src.connect(dest);

  chunks = [];
  recorder.start();
  src.start();

  await new Promise(r => src.onended = r);
  recorder.stop();
  await new Promise(r => recorder.onstop = r);

  src.disconnect();

  return new Blob(chunks, { type:"audio/ogg" });
}

/* ===== 1ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ› ===== */
async function convertNext(){
  if(converting) return;
  if(index >= wavList.length) return;

  converting = true;
  convertBtn.disabled = true;

  const item = wavList[index];
  log(`å¤‰æ›ä¸­: ${item.name}`);

  try {
    const wav = await item.file.async("blob");
    const ogg = await wavToOgg(wav);
    outZip.file(item.name.replace(".wav",".ogg"), ogg);

    index++;
    updateStatus();

    if(index === wavList.length){
      log("ğŸ‰ å…¨ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›å®Œäº†ï¼");
      await downloadZip();
    }

  } catch(e){
    log("âŒ ã‚¨ãƒ©ãƒ¼: " + e);
  }

  converting = false;
  convertBtn.disabled = false;
}

/* ===== çŠ¶æ…‹è¡¨ç¤º ===== */
function updateStatus(){
  setStatus(`ğŸš¦ æ®‹ã‚Š ${wavList.length - index} / ${wavList.length}`);
}

/* ===== zipãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ ===== */
async function downloadZip(){
  setStatus("ğŸ“¦ zipç”Ÿæˆä¸­â€¦");
  const blob = await outZip.generateAsync({ type:"blob" });

  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "SKRC_ogg_converted.zip";
  a.click();

  setStatus("âœ… ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼");
}

/* ===== zipèª­è¾¼ ===== */
document.getElementById("zip").addEventListener("change", async e => {
  wavList = [];
  index = 0;
  document.getElementById("log").textContent = "";

  const zip = await JSZip.loadAsync(e.target.files[0]);

  for(const name of Object.keys(zip.files)){
    if(name.endsWith(".wav")){
      wavList.push({ name, file: zip.files[name] });
    }
  }

  if(wavList.length === 0){
    log("âŒ wavãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
    return;
  }

  log(`âœ… ${wavList.length} å€‹ã® wav ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
  updateStatus();
});

/* ===== ãƒœã‚¿ãƒ³æ“ä½œ ===== */
const convertBtn = document.getElementById("convertBtn");

convertBtn.addEventListener("click", convertNext);

// é•·æŠ¼ã—ï¼è‡ªå‹•å¤‰æ›
convertBtn.addEventListener("mousedown", () => {
  autoTimer = setInterval(() => {
    if(index < wavList.length){
      convertNext();
    }
  }, 800); // â˜… é–“éš”ï¼ˆå®‰å…¨ï¼‰
});

document.addEventListener("mouseup", () => {
  clearInterval(autoTimer);
});
</script>
</body>
</html>
