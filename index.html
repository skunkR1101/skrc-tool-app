<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>SKRC wav â†’ ogg æ‰‹å‹•å¤‰æ›ãƒ„ãƒ¼ãƒ«</title>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<style>
body {
  background:#111;
  color:#eee;
  font-family:sans-serif;
  padding:20px;
}
button {
  padding:10px 20px;
  font-size:16px;
  margin-top:10px;
}
#log {
  white-space:pre-line;
  margin-top:15px;
  font-size:14px;
}
.progress {
  margin-top:10px;
}
</style>
</head>

<body>
<h2>SKRC wav â†’ ogg é€£æ‰“å¤‰æ›ãƒ„ãƒ¼ãƒ«</h2>

<input type="file" id="zip" accept=".zip"><br><br>
<button onclick="loadZip()">zipèª­ã¿è¾¼ã¿</button><br><br>

<button id="convertBtn" onclick="convertNext()" disabled>
â–¶ æ¬¡ã‚’å¤‰æ›
</button>

<div class="progress" id="progress"></div>
<div id="log"></div>

<script>
let wavList = [];
let index = 0;
let outZip = new JSZip();
let audioCtx = null;

function log(t){
  document.getElementById("log").textContent += t + "\n";
}

async function loadZip(){
  document.getElementById("log").textContent = "";
  index = 0;
  wavList = [];
  outZip = new JSZip();

  const file = document.getElementById("zip").files[0];
  if(!file){
    log("âŒ zipãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“");
    return;
  }

  const zip = await JSZip.loadAsync(file);

  for(const name of Object.keys(zip.files)){
    if(name.endsWith(".wav")){
      wavList.push({ name, file: zip.files[name] });
    }
  }

  if(wavList.length === 0){
    log("âŒ wavãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
    return;
  }

  log(`âœ… ${wavList.length} å€‹ã® wav ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`);
  updateProgress();
  document.getElementById("convertBtn").disabled = false;
}

async function wavToOgg(blob){
  if(!audioCtx){
    audioCtx = new AudioContext();
    await audioCtx.resume();
  }

  const buf = await blob.arrayBuffer();
  const buffer = await audioCtx.decodeAudioData(buf);

  const dest = audioCtx.createMediaStreamDestination();
  const src = audioCtx.createBufferSource();
  src.buffer = buffer;
  src.connect(dest);
  src.connect(audioCtx.destination);

  const recorder = new MediaRecorder(dest.stream, { mimeType:"audio/ogg" });
  const chunks = [];

  recorder.ondataavailable = e => chunks.push(e.data);

  recorder.start();
  src.start();

  await new Promise(r => src.onended = r);
  recorder.stop();
  await new Promise(r => recorder.onstop = r);

  return new Blob(chunks, { type:"audio/ogg" });
}

async function convertNext(){
  if(index >= wavList.length){
    return;
  }

  const item = wavList[index];
  log(`å¤‰æ›ä¸­: ${item.name}`);

  const wavBlob = await item.file.async("blob");
  const oggBlob = await wavToOgg(wavBlob);

  outZip.file(item.name.replace(".wav",".ogg"), oggBlob);

  index++;
  updateProgress();

  if(index === wavList.length){
    log("ğŸ‰ å…¨ã¦å¤‰æ›å®Œäº†ï¼");
    downloadZip();
  }
}

function updateProgress(){
  document.getElementById("progress").textContent =
    `é€²æ—: ${index} / ${wavList.length}`;
}

async function downloadZip(){
  const blob = await outZip.generateAsync({ type:"blob" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "SKRC_ogg_converted.zip";
  a.click();
}
</script>
</body>
</html>
